# NFL Prediction Pipeline

`pipeline/predict.py` turns a trained anytime-touchdown model into an actionable slate.  
It mirrors the data flow established for training—schedule → roster → rolling features → inference—
so the numbers you see match the assumptions baked into the model.

## Quick Start

```bash
PYTHONPATH=. ./venv/bin/python pipeline/predict.py --date 2024-12-29 --days 1
```

- **Inputs**
  - Latest model + artifacts from `output/models/anytime_td/xgboost/<timestamp>/`.
  - Inference artifacts (`output/models/inference_artifacts_anytime_td.joblib`) for frozen feature order + categorical levels.
  - Up-to-date rolling caches (`cache/feature/daily_totals/`) generated by `pipeline/feature.py`.
- **Outputs**
  - CSV under `output/predictions/anytime_td_predictions_<start>_<end>.csv` with one row per player/game.
  - Columns include identifiers, positional context, model probability, binary decision, and implied decimal odds.

## End-to-End Flow

1. **Schedule ingestion**  
   Pulls the upcoming slate from `nfl_data_py.import_schedules`, filtered to regular/post-season games in the requested window.

2. **Roster scaffolding**  
   Uses `nfl_data_py.import_weekly_rosters` to assemble active QB/RB/WR/TE players for each team + week, preserving depth-chart info and game identifiers.

3. **Feature enrichment**  
   Converts the scaffold to Polars, calls `utils.feature.rolling_window.add_rolling_features`, and injects the exact rolling prefixes used at training time (`1g_`, `2g_`, `seasong_`, etc.).  
   Missing game-level columns (`target_share`, `carry_share`, …) are zero-filled because there is no box score yet.

4. **Artifact alignment**  
   Reindexes to the frozen feature list, reapplies categorical codes, and downcasts numeric columns to match the training matrix.

5. **Scoring + export**  
   Loads the newest XGBoost model, applies the calibrated decision threshold from the latest metrics file, and writes predictions sorted by game/team/player.

## Operational Notes

- **Date windows** – `--date` defaults to today; `--days` extends the window forward for multi-day slates.  
  The script automatically fetches both schedule and roster data for every season touched by the window.

- **Model threshold** – Pulled from `output/metrics/anytime_td/xgboost/<timestamp>/metrics.yaml`.
  Adjust locally if you want a different risk tolerance.

- **Dependency on caches** – Run `pipeline/clean.py` + `pipeline/feature.py` before predicting so that rolling windows include the most recent games.

- **Extending to other problems** – Duplicate the script, point to a different model/artifact pair, and plug in the appropriate rolling stats list.

This pipeline now generates predictions from the same data abstractions the model was trained on—no more MLB placeholders or “latest game only” shortcuts. 

## Legacy MLB / Statcast stack

Historical MLB tooling (rolling windows, Statcast feature cache, etc.) is still in
the repo for reference, but it is **quarantined**. See `docs/mlb_legacy.md` for
details on how to opt in via `pytest --run-mlb` if you need to run those tests
locally. The NFL pipeline does not depend on any of that legacy path.